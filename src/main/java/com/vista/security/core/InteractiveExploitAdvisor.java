package com.vista.security.core;

import java.util.*;

/**
 * Interactive Exploit Advisor - Asks clarifying questions to gather context
 * and provide targeted exploitation advice.
 */
public class InteractiveExploitAdvisor {

    public static class Question {
        public final String question;
        public final List<String> options; // null for free text
        public final String purpose;

        public Question(String question, List<String> options, String purpose) {
            this.question = question;
            this.options = options;
            this.purpose = purpose;
        }
    }

    public static class ExploitContext {
        public String vulnerabilityType;
        public String wafDetected;
        public String reflectionContext;
        public String errorMessages;
        public String goal;
        public Map<String, String> additionalInfo = new HashMap<>();
    }

    /**
     * Generate context-aware questions based on vulnerability type and initial analysis.
     */
    public static List<Question> generateQuestions(String vulnType, String requestContext, String responseContext) {
        List<Question> questions = new ArrayList<>();

        switch (vulnType.toUpperCase()) {
            case "XSS", "CROSS-SITE SCRIPTING" -> questions.addAll(getXSSQuestions(requestContext, responseContext));
            case "SQLI", "SQL INJECTION" -> questions.addAll(getSQLiQuestions(requestContext, responseContext));
            case "SSTI" -> questions.addAll(getSSTIQuestions(requestContext, responseContext));
            case "COMMAND INJECTION", "RCE" -> questions.addAll(getCommandInjectionQuestions(requestContext, responseContext));
            case "SSRF" -> questions.addAll(getSSRFQuestions(requestContext, responseContext));
            case "XXE" -> questions.addAll(getXXEQuestions(requestContext, responseContext));
            case "AUTH BYPASS" -> questions.addAll(getAuthBypassQuestions(requestContext, responseContext));
            default -> questions.addAll(getGeneralQuestions(requestContext, responseContext));
        }

        return questions;
    }

    private static List<Question> getXSSQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        // Check reflection context
        questions.add(new Question(
            "Where is your payload reflected in the response?",
            Arrays.asList(
                "Inside HTML body (between tags)",
                "Inside HTML attribute (e.g., <input value='HERE'>)",
                "Inside JavaScript code (e.g., var x = 'HERE')",
                "Inside JavaScript template literal (e.g., `${HERE}`)",
                "Inside event handler (e.g., onclick='HERE')",
                "Inside <script> tag",
                "Not reflected / Don't know"
            ),
            "Determines which bypass technique to use"
        ));

        // Check for CSP
        if (response.toLowerCase().contains("content-security-policy")) {
            questions.add(new Question(
                "I detected a Content Security Policy (CSP). What's your goal?",
                Arrays.asList(
                    "Bypass CSP to execute JavaScript",
                    "Exfiltrate data without executing JS",
                    "Find CSP misconfiguration",
                    "Use allowed domains for exploitation"
                ),
                "CSP requires specific bypass techniques"
            ));
        }

        // Check for encoding
        questions.add(new Question(
            "Is your payload being encoded in the response?",
            Arrays.asList(
                "Yes - HTML encoded (< becomes &lt;)",
                "Yes - URL encoded (< becomes %3C)",
                "Yes - JavaScript encoded (< becomes \\x3c)",
                "Partially encoded",
                "No encoding detected",
                "Don't know"
            ),
            "Determines if we need encoding bypass"
        ));

        // Goal
        questions.add(new Question(
            "What's your exploitation goal?",
            Arrays.asList(
                "Cookie theft / Session hijacking",
                "Keylogging",
                "Defacement",
                "Phishing / Credential theft",
                "Account takeover",
                "Just PoC (alert box)",
                "Bypass WAF for bug bounty report"
            ),
            "Helps generate appropriate payload"
        ));

        // WAF detection
        questions.add(new Question(
            "Did you see any WAF/security error? (paste error message or say 'none')",
            null, // Free text
            "Helps identify WAF and apply specific bypasses"
        ));

        return questions;
    }

    private static List<Question> getSQLiQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        // Database type
        questions.add(new Question(
            "What database is the application using?",
            Arrays.asList(
                "MySQL / MariaDB",
                "PostgreSQL",
                "Microsoft SQL Server (MSSQL)",
                "Oracle",
                "SQLite",
                "MongoDB (NoSQL)",
                "Don't know - need to fingerprint"
            ),
            "Different databases require different syntax"
        ));

        // Error visibility
        questions.add(new Question(
            "Can you see database errors in the response?",
            Arrays.asList(
                "Yes - full SQL error messages",
                "Yes - partial error hints",
                "No - generic error page",
                "No - no visible errors",
                "Application behaves differently (boolean-based)"
            ),
            "Determines injection technique (error-based vs blind)"
        ));

        // Time-based confirmation
        questions.add(new Question(
            "Can you trigger time delays? (e.g., SLEEP(5) causes 5-second delay)",
            Arrays.asList(
                "Yes - confirmed time delay",
                "No - no delay observed",
                "Haven't tried yet"
            ),
            "Confirms blind SQL injection"
        ));

        // Goal
        questions.add(new Question(
            "What's your goal?",
            Arrays.asList(
                "Authentication bypass (login as admin)",
                "Data extraction (dump database)",
                "File read (LOAD_FILE)",
                "File write / RCE",
                "Just confirm vulnerability for report"
            ),
            "Determines exploitation strategy"
        ));

        // WAF
        questions.add(new Question(
            "Are your SQL keywords being blocked? (e.g., SELECT, UNION)",
            Arrays.asList(
                "Yes - specific keywords blocked",
                "Yes - all SQL syntax blocked",
                "No - payloads go through",
                "Don't know"
            ),
            "Determines if WAF bypass is needed"
        ));

        return questions;
    }

    private static List<Question> getSSTIQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "What template engine is the application using?",
            Arrays.asList(
                "Jinja2 (Python/Flask)",
                "Twig (PHP)",
                "Freemarker (Java)",
                "Velocity (Java)",
                "Thymeleaf (Java)",
                "ERB (Ruby)",
                "Smarty (PHP)",
                "Don't know - need to detect"
            ),
            "Each template engine has different syntax"
        ));

        questions.add(new Question(
            "Did {{7*7}} or ${7*7} evaluate to 49?",
            Arrays.asList(
                "Yes - {{7*7}} = 49",
                "Yes - ${7*7} = 49",
                "Yes - other syntax worked",
                "No - not evaluated",
                "Haven't tried"
            ),
            "Confirms SSTI and helps identify engine"
        ));

        questions.add(new Question(
            "What's your goal?",
            Arrays.asList(
                "Remote Code Execution (RCE)",
                "File read",
                "Information disclosure",
                "Just confirm vulnerability"
            ),
            "Determines payload complexity"
        ));

        return questions;
    }

    private static List<Question> getCommandInjectionQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "What operating system is the server running?",
            Arrays.asList(
                "Linux / Unix",
                "Windows",
                "Don't know"
            ),
            "Different OS require different commands"
        ));

        questions.add(new Question(
            "Can you trigger time delays? (e.g., sleep 5)",
            Arrays.asList(
                "Yes - confirmed delay",
                "No - no delay",
                "Haven't tried"
            ),
            "Confirms blind command injection"
        ));

        questions.add(new Question(
            "Are spaces being filtered?",
            Arrays.asList(
                "Yes - spaces blocked",
                "No - spaces work",
                "Don't know"
            ),
            "Determines if space bypass is needed"
        ));

        questions.add(new Question(
            "What's your goal?",
            Arrays.asList(
                "Confirm vulnerability (whoami, id)",
                "Read sensitive files (/etc/passwd)",
                "Reverse shell",
                "Data exfiltration"
            ),
            "Determines payload strategy"
        ));

        return questions;
    }

    private static List<Question> getSSRFQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "What URL validation is in place?",
            Arrays.asList(
                "Whitelist of allowed domains",
                "Blacklist of localhost/internal IPs",
                "No validation detected",
                "Don't know"
            ),
            "Determines bypass technique"
        ));

        questions.add(new Question(
            "Can you access localhost (127.0.0.1)?",
            Arrays.asList(
                "Yes - direct access works",
                "No - blocked",
                "Haven't tried"
            ),
            "Determines if localhost bypass is needed"
        ));

        questions.add(new Question(
            "What's your goal?",
            Arrays.asList(
                "Access internal services (Redis, Memcached)",
                "Port scanning",
                "Cloud metadata (AWS, Azure, GCP)",
                "File read (file:// protocol)",
                "Just confirm vulnerability"
            ),
            "Determines exploitation strategy"
        ));

        return questions;
    }

    private static List<Question> getXXEQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "Does the application accept XML input?",
            Arrays.asList(
                "Yes - direct XML POST",
                "Yes - via file upload (SVG, DOCX, XLSX)",
                "Yes - SOAP API",
                "No / Don't know"
            ),
            "Determines injection point"
        ));

        questions.add(new Question(
            "Can you see the XML content reflected in response?",
            Arrays.asList(
                "Yes - full reflection",
                "No - blind XXE",
                "Don't know"
            ),
            "Determines if OOB technique is needed"
        ));

        return questions;
    }

    private static List<Question> getAuthBypassQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "What authentication mechanism is used?",
            Arrays.asList(
                "Username/Password form",
                "JWT tokens",
                "Session cookies",
                "OAuth / SSO",
                "API keys",
                "Don't know"
            ),
            "Determines bypass approach"
        ));

        questions.add(new Question(
            "What's your goal?",
            Arrays.asList(
                "Bypass login (access without credentials)",
                "Privilege escalation (user -> admin)",
                "Session hijacking",
                "Account takeover"
            ),
            "Determines exploitation strategy"
        ));

        return questions;
    }

    private static List<Question> getGeneralQuestions(String request, String response) {
        List<Question> questions = new ArrayList<>();

        questions.add(new Question(
            "What error messages or unusual behavior do you see?",
            null, // Free text
            "Helps identify vulnerability type"
        ));

        questions.add(new Question(
            "What's your testing goal?",
            Arrays.asList(
                "Find any vulnerability",
                "Bypass specific protection",
                "Exploit for maximum impact",
                "Generate PoC for bug bounty"
            ),
            "Determines testing approach"
        ));

        return questions;
    }

    /**
     * Build enhanced AI prompt with gathered context.
     */
    public static String buildEnhancedPrompt(String originalPrompt, ExploitContext context, String bypassKnowledge) {
        StringBuilder prompt = new StringBuilder();
        
        prompt.append("# EXPLOITATION TASK\n\n");
        prompt.append("Original Goal: ").append(originalPrompt).append("\n\n");
        
        prompt.append("# GATHERED CONTEXT\n\n");
        if (context.wafDetected != null) {
            prompt.append("WAF Detected: ").append(context.wafDetected).append("\n");
        }
        if (context.reflectionContext != null) {
            prompt.append("Reflection Context: ").append(context.reflectionContext).append("\n");
        }
        if (context.errorMessages != null) {
            prompt.append("Error Messages: ").append(context.errorMessages).append("\n");
        }
        if (context.goal != null) {
            prompt.append("Exploitation Goal: ").append(context.goal).append("\n");
        }
        
        for (Map.Entry<String, String> entry : context.additionalInfo.entrySet()) {
            prompt.append(entry.getKey()).append(": ").append(entry.getValue()).append("\n");
        }
        
        prompt.append("\n# BYPASS KNOWLEDGE BASE\n\n");
        prompt.append(bypassKnowledge);
        
        prompt.append("\n\n# INSTRUCTIONS\n\n");
        prompt.append("Based on the context above:\n");
        prompt.append("1. Generate SPECIFIC payloads tailored to this exact scenario\n");
        prompt.append("2. Apply WAF-specific bypasses if WAF detected\n");
        prompt.append("3. Use the bypass knowledge base for proven techniques\n");
        prompt.append("4. Focus on REAL exploitation, not generic testing\n");
        prompt.append("5. Provide step-by-step exploitation strategy\n");
        prompt.append("6. Generate actual PoC code if needed\n");
        
        return prompt.toString();
    }
}
