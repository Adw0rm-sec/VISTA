package com.vista.security.model;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Base64;
import java.util.Map;
import java.util.UUID;

/**
 * Represents a successful exploit finding.
 * Stored globally and accessible across VISTA tabs.
 */
public class ExploitFinding {
    
    private final String id;
    private final LocalDateTime timestamp;
    private final String host;
    private final String endpoint;
    private final String method;
    private final String parameter;
    private final String exploitType;
    private final String payload;
    private final String indicator;
    private final int statusCode;
    private final int responseLength;
    private final long responseTime;
    private final byte[] request;
    private final byte[] response;
    private String severity;
    private String notes;
    private boolean verified;
    
    public ExploitFinding(String host, String endpoint, String method, String parameter,
                         String exploitType, String payload, String indicator,
                         int statusCode, int responseLength, long responseTime,
                         byte[] request, byte[] response) {
        this.id = UUID.randomUUID().toString().substring(0, 8);
        this.timestamp = LocalDateTime.now();
        this.host = host;
        this.endpoint = endpoint;
        this.method = method;
        this.parameter = parameter;
        this.exploitType = exploitType;
        this.payload = payload;
        this.indicator = indicator;
        this.statusCode = statusCode;
        this.responseLength = responseLength;
        this.responseTime = responseTime;
        this.request = request;
        this.response = response;
        this.severity = determineSeverity(exploitType);
        this.verified = false;
    }
    
    private String determineSeverity(String type) {
        return switch (type.toUpperCase()) {
            case "SQLI", "SQL", "COMMAND", "RCE" -> "Critical";
            case "XSS" -> "High";
            case "PATH", "LFI", "TRAVERSAL" -> "High";
            case "AUTH", "IDOR" -> "High";
            default -> "Medium";
        };
    }
    
    // Getters
    public String getId() { return id; }
    public LocalDateTime getTimestamp() { return timestamp; }
    public String getHost() { return host; }
    public String getEndpoint() { return endpoint; }
    public String getMethod() { return method; }
    public String getParameter() { return parameter; }
    public String getExploitType() { return exploitType; }
    public String getPayload() { return payload; }
    public String getIndicator() { return indicator; }
    public int getStatusCode() { return statusCode; }
    public int getResponseLength() { return responseLength; }
    public long getResponseTime() { return responseTime; }
    public byte[] getRequest() { return request; }
    public byte[] getResponse() { return response; }
    public String getSeverity() { return severity; }
    public String getNotes() { return notes; }
    public boolean isVerified() { return verified; }
    
    // Setters
    public void setSeverity(String severity) { this.severity = severity; }
    public void setNotes(String notes) { this.notes = notes; }
    public void setVerified(boolean verified) { this.verified = verified; }
    
    public String getFormattedTimestamp() {
        return timestamp.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
    }
    
    public String getSummary() {
        return String.format("[%s] %s %s - %s on '%s'", 
            severity, method, endpoint, exploitType, parameter);
    }
    
    public String getDetailedReport() {
        StringBuilder sb = new StringBuilder();
        sb.append("═══════════════════════════════════════════════════════\n");
        sb.append("EXPLOIT FINDING REPORT\n");
        sb.append("═══════════════════════════════════════════════════════\n\n");
        sb.append("ID: ").append(id).append("\n");
        sb.append("Time: ").append(getFormattedTimestamp()).append("\n");
        sb.append("Severity: ").append(severity).append("\n");
        sb.append("Verified: ").append(verified ? "Yes" : "No").append("\n\n");
        sb.append("TARGET\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Host: ").append(host).append("\n");
        sb.append("Endpoint: ").append(method).append(" ").append(endpoint).append("\n");
        sb.append("Parameter: ").append(parameter).append("\n\n");
        sb.append("EXPLOIT\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Type: ").append(exploitType).append("\n");
        sb.append("Payload: ").append(payload).append("\n");
        sb.append("Indicator: ").append(indicator).append("\n\n");
        sb.append("RESPONSE\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Status: ").append(statusCode).append("\n");
        sb.append("Length: ").append(responseLength).append(" bytes\n");
        sb.append("Time: ").append(responseTime).append("ms\n");
        if (notes != null && !notes.isEmpty()) {
            sb.append("\nNOTES\n");
            sb.append("───────────────────────────────────────────────────────\n");
            sb.append(notes).append("\n");
        }
        sb.append("\n═══════════════════════════════════════════════════════\n");
        return sb.toString();
    }
    
    /**
     * Private constructor for deserialization.
     */
    private ExploitFinding(String id, LocalDateTime timestamp, String host, String endpoint,
                          String method, String parameter, String exploitType, String payload,
                          String indicator, int statusCode, int responseLength, long responseTime,
                          byte[] request, byte[] response, String severity, String notes, boolean verified) {
        this.id = id;
        this.timestamp = timestamp;
        this.host = host;
        this.endpoint = endpoint;
        this.method = method;
        this.parameter = parameter;
        this.exploitType = exploitType;
        this.payload = payload;
        this.indicator = indicator;
        this.statusCode = statusCode;
        this.responseLength = responseLength;
        this.responseTime = responseTime;
        this.request = request;
        this.response = response;
        this.severity = severity;
        this.notes = notes;
        this.verified = verified;
    }
    
    /**
     * Serializes this ExploitFinding to a JSON string for persistence.
     */
    public String toJson() {
        StringBuilder sb = new StringBuilder();
        sb.append("{\n");
        sb.append("  \"id\": ").append(jsonStr(id)).append(",\n");
        sb.append("  \"timestamp\": ").append(jsonStr(timestamp.format(DateTimeFormatter.ISO_LOCAL_DATE_TIME))).append(",\n");
        sb.append("  \"host\": ").append(jsonStr(host)).append(",\n");
        sb.append("  \"endpoint\": ").append(jsonStr(endpoint)).append(",\n");
        sb.append("  \"method\": ").append(jsonStr(method)).append(",\n");
        sb.append("  \"parameter\": ").append(jsonStr(parameter)).append(",\n");
        sb.append("  \"exploitType\": ").append(jsonStr(exploitType)).append(",\n");
        sb.append("  \"payload\": ").append(jsonStr(payload)).append(",\n");
        sb.append("  \"indicator\": ").append(jsonStr(indicator)).append(",\n");
        sb.append("  \"statusCode\": ").append(statusCode).append(",\n");
        sb.append("  \"responseLength\": ").append(responseLength).append(",\n");
        sb.append("  \"responseTime\": ").append(responseTime).append(",\n");
        sb.append("  \"request\": ").append(request != null ? jsonStr(Base64.getEncoder().encodeToString(request)) : "null").append(",\n");
        sb.append("  \"response\": ").append(response != null ? jsonStr(Base64.getEncoder().encodeToString(response)) : "null").append(",\n");
        sb.append("  \"severity\": ").append(jsonStr(severity)).append(",\n");
        sb.append("  \"notes\": ").append(jsonStr(notes)).append(",\n");
        sb.append("  \"verified\": ").append(verified).append("\n");
        sb.append("}");
        return sb.toString();
    }
    
    /**
     * Deserializes an ExploitFinding from a JSON string.
     */
    public static ExploitFinding fromJson(String json) {
        try {
            Map<String, String> f = HttpTransaction.parseJsonObject(json);
            if (f == null || !f.containsKey("id")) return null;
            
            String id = f.get("id");
            LocalDateTime ts = LocalDateTime.parse(f.getOrDefault("timestamp", 
                    LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME)),
                    DateTimeFormatter.ISO_LOCAL_DATE_TIME);
            String host = f.getOrDefault("host", "");
            String endpoint = f.getOrDefault("endpoint", "");
            String method = f.getOrDefault("method", "GET");
            String parameter = f.getOrDefault("parameter", "");
            String exploitType = f.getOrDefault("exploitType", "");
            String payload = f.getOrDefault("payload", "");
            String indicator = f.getOrDefault("indicator", "");
            int statusCode = Integer.parseInt(f.getOrDefault("statusCode", "0"));
            int responseLength = Integer.parseInt(f.getOrDefault("responseLength", "0"));
            long responseTime = Long.parseLong(f.getOrDefault("responseTime", "0"));
            
            byte[] request = null;
            String reqB64 = f.get("request");
            if (reqB64 != null && !reqB64.equals("null") && !reqB64.isEmpty()) {
                request = Base64.getDecoder().decode(reqB64);
            }
            byte[] response = null;
            String respB64 = f.get("response");
            if (respB64 != null && !respB64.equals("null") && !respB64.isEmpty()) {
                response = Base64.getDecoder().decode(respB64);
            }
            
            String severity = f.getOrDefault("severity", "Medium");
            String notes = f.get("notes");
            boolean verified = "true".equals(f.getOrDefault("verified", "false"));
            
            return new ExploitFinding(id, ts, host, endpoint, method, parameter,
                    exploitType, payload, indicator, statusCode, responseLength,
                    responseTime, request, response, severity, notes, verified);
        } catch (Exception e) {
            System.err.println("[VISTA] Error deserializing ExploitFinding: " + e.getMessage());
            return null;
        }
    }
    
    private static String jsonStr(String s) {
        if (s == null) return "null";
        return "\"" + s.replace("\\", "\\\\")
                       .replace("\"", "\\\"")
                       .replace("\n", "\\n")
                       .replace("\r", "\\r")
                       .replace("\t", "\\t") + "\"";
    }
    
    @Override
    public String toString() {
        return getSummary();
    }
}
