package com.vista.security.model;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;

/**
 * Represents a successful exploit finding.
 * Stored globally and accessible across VISTA tabs.
 */
public class ExploitFinding {
    
    private final String id;
    private final LocalDateTime timestamp;
    private final String host;
    private final String endpoint;
    private final String method;
    private final String parameter;
    private final String exploitType;
    private final String payload;
    private final String indicator;
    private final int statusCode;
    private final int responseLength;
    private final long responseTime;
    private final byte[] request;
    private final byte[] response;
    private String severity;
    private String notes;
    private boolean verified;
    
    public ExploitFinding(String host, String endpoint, String method, String parameter,
                         String exploitType, String payload, String indicator,
                         int statusCode, int responseLength, long responseTime,
                         byte[] request, byte[] response) {
        this.id = UUID.randomUUID().toString().substring(0, 8);
        this.timestamp = LocalDateTime.now();
        this.host = host;
        this.endpoint = endpoint;
        this.method = method;
        this.parameter = parameter;
        this.exploitType = exploitType;
        this.payload = payload;
        this.indicator = indicator;
        this.statusCode = statusCode;
        this.responseLength = responseLength;
        this.responseTime = responseTime;
        this.request = request;
        this.response = response;
        this.severity = determineSeverity(exploitType);
        this.verified = false;
    }
    
    private String determineSeverity(String type) {
        return switch (type.toUpperCase()) {
            case "SQLI", "SQL", "COMMAND", "RCE" -> "Critical";
            case "XSS" -> "High";
            case "PATH", "LFI", "TRAVERSAL" -> "High";
            case "AUTH", "IDOR" -> "High";
            default -> "Medium";
        };
    }
    
    // Getters
    public String getId() { return id; }
    public LocalDateTime getTimestamp() { return timestamp; }
    public String getHost() { return host; }
    public String getEndpoint() { return endpoint; }
    public String getMethod() { return method; }
    public String getParameter() { return parameter; }
    public String getExploitType() { return exploitType; }
    public String getPayload() { return payload; }
    public String getIndicator() { return indicator; }
    public int getStatusCode() { return statusCode; }
    public int getResponseLength() { return responseLength; }
    public long getResponseTime() { return responseTime; }
    public byte[] getRequest() { return request; }
    public byte[] getResponse() { return response; }
    public String getSeverity() { return severity; }
    public String getNotes() { return notes; }
    public boolean isVerified() { return verified; }
    
    // Setters
    public void setSeverity(String severity) { this.severity = severity; }
    public void setNotes(String notes) { this.notes = notes; }
    public void setVerified(boolean verified) { this.verified = verified; }
    
    public String getFormattedTimestamp() {
        return timestamp.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
    }
    
    public String getSummary() {
        return String.format("[%s] %s %s - %s on '%s'", 
            severity, method, endpoint, exploitType, parameter);
    }
    
    public String getDetailedReport() {
        StringBuilder sb = new StringBuilder();
        sb.append("═══════════════════════════════════════════════════════\n");
        sb.append("EXPLOIT FINDING REPORT\n");
        sb.append("═══════════════════════════════════════════════════════\n\n");
        sb.append("ID: ").append(id).append("\n");
        sb.append("Time: ").append(getFormattedTimestamp()).append("\n");
        sb.append("Severity: ").append(severity).append("\n");
        sb.append("Verified: ").append(verified ? "Yes" : "No").append("\n\n");
        sb.append("TARGET\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Host: ").append(host).append("\n");
        sb.append("Endpoint: ").append(method).append(" ").append(endpoint).append("\n");
        sb.append("Parameter: ").append(parameter).append("\n\n");
        sb.append("EXPLOIT\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Type: ").append(exploitType).append("\n");
        sb.append("Payload: ").append(payload).append("\n");
        sb.append("Indicator: ").append(indicator).append("\n\n");
        sb.append("RESPONSE\n");
        sb.append("───────────────────────────────────────────────────────\n");
        sb.append("Status: ").append(statusCode).append("\n");
        sb.append("Length: ").append(responseLength).append(" bytes\n");
        sb.append("Time: ").append(responseTime).append("ms\n");
        if (notes != null && !notes.isEmpty()) {
            sb.append("\nNOTES\n");
            sb.append("───────────────────────────────────────────────────────\n");
            sb.append(notes).append("\n");
        }
        sb.append("\n═══════════════════════════════════════════════════════\n");
        return sb.toString();
    }
    
    @Override
    public String toString() {
        return getSummary();
    }
}
